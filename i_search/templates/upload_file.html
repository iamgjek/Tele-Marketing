<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <title>上傳檔案</title>
    <link rel="icon" type="image/ico" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.js"></script>
    <script src="/static/js/spinner.js"></script>
    <!-- spinner from https://icons8.com/preloaders/ -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
</head>
<body>
    <div id='upload_file'>
        <div class='col-md-12'>
            <form name="upload_file" action="{% url 'upload_file' %}" method='POST' enctype="multipart/form-data">
                <table border="1" class="table">
                    <tr>
                        <td width="20%">檔案處理作業</td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <input type="file" name="file" onchange="check_file(this)" accept="text/csv, text/xml, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required id="upload_file">
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <input type="reset" id="reset" value="重設">
                        </td>
                        <td width="20%">
                            <input type="submit" id="go_work" value='上傳檔案'>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <hr>
        <div>
            <table border="1" class="table">
                <tr>
                    <td width="20%">上傳結果</td>
                    <td width="80%">
                        <div id='upload_file_result'>
                            {% if results != None %} {{ results }} {% endif %}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <hr>
        <div>請遵守個人資料保護法之相關規定，審慎處理及保護個人資料，如違反法律規定，致當事人權益受損害，須負法律責任。</div>
    </div>
    <script>
    
        function upload(){
            $('#upload_file').click()
        };
        
        function check_file(input_file){
            fileObj = input_file.files[0];
            if (['text/csv', 'text/xml', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'].indexOf(fileObj.type) == -1)
            {
                console.log(fileObj.type);
                alert('您選擇了未支持格式的檔案，請選擇csv/xml/excel檔案');
            }
        };
    
        $("#go_work").click(function(event) {
            event.preventDefault();
            go_work(this);
        });
    
        function go_work(ldpform){
            openYH();
            var form = ldpform.closest('form');
            var formData = new FormData(form);
            $.ajax({
                type: "POST",
                url: "{% url 'upload_file' %}",
                data: formData,
                dataType: 'html',
                timeout: 0,
                processData : false,
                contentType : false,
                success: function (response) {
                    console.log('success');
                    $('#upload_file_result').html(response);
                    closeYH();
                },
                error: function (response) {
                    console.log('error');
                    $('#upload_file_result').html(response);
                    closeYH();
                }
            })
        };
    </script>
</body>
</html>